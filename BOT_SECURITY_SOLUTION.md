# Решение проблемы двойного подключения Telegram бота

## Проблема
Ошибка 409: "Conflict: terminated by other getUpdates request; make sure that only one bot instance is running"

## Анализ
Из логов видно, что запущено несколько экземпляров бота одновременно, что вызывает конфликт в Telegram API.

## Решение

### 1. Система управления процессами (`bot_manager.py`)
- Автоматическое обнаружение запущенных процессов бота
- Безопасное завершение конфликтующих процессов
- Система блокировки с файлами `.lock` и `.pid`
- Команды: `start`, `stop`, `status`, `check`

### 2. Система блокировки в коде бота (`bot/main.py`)
- Проверка блокировки при запуске
- Создание файла блокировки с PID процесса
- Обработчики сигналов для корректного завершения
- Автоматическое удаление блокировки при выходе

### 3. Проверка системы перед запуском (`startup_check.py`)
- Проверка версии Python
- Проверка зависимостей
- Проверка структуры проекта
- Проверка переменных окружения
- Проверка запущенных процессов
- Тест подключения к боту

### 4. Безопасный запуск (`run_bot.py`)
- Автоматическая проверка системы
- Управление процессами через менеджер
- Корректное завершение при ошибках

## Использование

### Безопасный запуск (рекомендуется)
```bash
python run_bot.py
```

### Быстрый запуск (для разработки)
```bash
python quick_start.py
```

### Управление процессами
```bash
# Проверка системы
python startup_check.py

# Статус процессов
python bot_manager.py status

# Остановка всех процессов
python bot_manager.py stop

# Запуск с проверками
python bot_manager.py start
```

## Файлы системы безопасности

- `bot_manager.py` - Менеджер процессов
- `startup_check.py` - Проверка системы
- `run_bot.py` - Безопасный запуск
- `quick_start.py` - Быстрый запуск
- `bot/main.py` - Основной код с блокировкой

## Принципы работы

1. **Блокировка процесса**: При запуске создается файл блокировки с PID
2. **Проверка конфликтов**: Система проверяет наличие других экземпляров
3. **Безопасное завершение**: Автоматическое удаление блокировки при выходе
4. **Обработка сигналов**: Корректное завершение по Ctrl+C или SIGTERM

## Безопасность

- Предотвращение двойного запуска
- Автоматическое завершение конфликтующих процессов
- Корректная очистка ресурсов
- Детальное логирование всех операций

## Логи

Все операции логируются в:
- `logs/bot_manager.log` - Управление процессами
- `logs/startup_check.log` - Проверки системы
- `logs/app.log` - Основные логи бота
- `logs/errors.log` - Ошибки

## Требования

- Python 3.8+
- psutil (для управления процессами)
- python-dotenv (для переменных окружения)
- telebot (основная библиотека бота)

## Установка зависимостей

```bash
pip install -r requirements.txt
```

## Проверка готовности системы

```bash
python startup_check.py
```

Если все проверки пройдены, система готова к безопасному запуску.
